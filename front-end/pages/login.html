<!doctype html>
<html>
<head>
    <meta charset="utf-8">

    <title>Log in</title>
    
    <script src="https://kit.fontawesome.com/0b420d52a0.js" crossorigin="anonymous"></script>

    <!-- Load external CSS styles -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        body {
            background-color: black;
            background-image: url('https://winnie2802.github.io/Website-Visualization/images/backgroundImage.jpg');
            background-size: cover;
            background-attachment: fixed;
            
            font-family: Arial;
            
            margin: 0;
        }

        .header {
            display: flex;
            align-items: center;
            
            padding-top: 20px;
            padding-left: 20px;
            padding-bottom: 20px;
        }
            .logoLabel {
                font-size: 30px;
                font-weight: 900;
            }

        .loginForm {
            background-color: white;

            width: max-content;
            height: max-content;

            border-radius: 10px;

            display: flex;
            flex-direction: column;
            
            margin: auto;

            padding: 30px;
        }
            .welcomeBackLabel {
                font-size: 20px;
                font-weight: bold;
                
                text-align: center;
            }
                .excitedLabel {
                    font-size: 18px;
                    font-weight: bold;
                    
                    text-align: center;
                }

            .emailLabel {
                font-size: 18px;
                font-weight: bold;

                margin-top: 20px;
            }
                .emailInput {
                    font-size: 16px;

                    width: 600px;
                    height: 30px;

                    margin-top: 10px;

                    padding-left: 10px;
                }

            .usernameLabel {
                font-size: 18px;
                font-weight: bold;

                margin-top: 20px;
            }
                .usernameInput {
                    font-size: 16px;

                    width: 600px;
                    height: 30px;

                    margin-top: 10px;

                    padding-left: 10px;
                }

            .passwordContainer {
                display: flex;
                justify-content: space-between;
            }
                .passwordLabel {
                    font-size: 18px;
                    font-weight: bold;

                    margin-top: 20px;
                }
                    .passwordInput {
                        font-size: 16px;

                        width: 600px;
                        height: 30px;

                        margin-top: 10px;

                        padding-left: 10px;
                    }
                
                .showLabel {
                    color: #5865F2;
                    
                    font-size: 16px;

                    align-content: end;
                    
                    margin-top: 20px;

                    cursor: pointer;
                    visibility: hidden;
                }
                    .showLabel.visible {
                        visibility: visible;
                    }
                
                .forgotPasswordContainer {
                    display: flex;
                    justify-content: flex-end;
                }
                    .forgotPasswordLink {
                        color: #5865F2;
                        
                        font-size: 16px;

                        width: max-content;
                        
                        margin-top: 10px;

                        cursor: pointer;
                        transition: 0.3s;
                    }
                        .forgotPasswordLink:hover {
                            text-decoration: underline;
                        }

            .loginButton {
                background-color: #5865F2;
                color: white;
                
                font-size: 16px;
                font-weight: bold;                

                width: 100%;

                border: none;
                border-radius: 10px;

                margin: auto;
                margin-top: 20px;
                
                padding-top: 10px;
                padding-bottom: 10px;

                cursor: pointer;
                transition: 0.3s;
            }
                .loginButton:hover {
                    opacity: 70%;
                }

            .registerContainer {
                    display: flex;
                    justify-content: flex-end;
                }
                .registerLink {
                    color: #5865F2;
                    
                    font-size: 16px;

                    margin-top: 10px;
                    
                    display: block;
                    text-align: right;

                    cursor: pointer;
                }
                    .registerLink:hover {
                        text-decoration: underline;
                    }
    </style>
</head>
<body>
    <div class="header">
        <div style="background-color: white; width: max-content; height: max-content; padding: 10px; display: flex; align-items: center; border-radius: 10px; cursor: pointer;" onclick="location.href='home.html'">
            <img src="https://winnie2802.github.io/Website-Visualization/images/homeLogo.png" width="40px" height="40px" style="margin-right: 10px;">
            <label class="logoLabel" style="cursor: pointer;">Home</label>
        </div>
    </div>

    <form id="loginForm" class="loginForm" >
        <label class="welcomeBackLabel">Welcome back!</label>
        <label class="excitedLabel">We're so excited to see you again!</label>
        
        <label class="usernameLabel">Username</label>
        <input id="username" name="username" class="usernameInput" type="text" placeholder="Enter your Username" required>

        <div class="passwordContainer">
            <label class="passwordLabel">Password</label>
            <label id="setVisible" class="showLabel">Show</label>
        </div>    
        <input id="password" name="password" class="passwordInput" type="password" placeholder="Enter your Password" required>

        <div class="forgotPasswordContainer">
            <label class="forgotPasswordLink">Forgot your password?</label>
        </div>

        <button class="loginButton" type="submit">Log in</button>

        <div class="registerContainer">
            <label class="registerLink" onclick="location.href='register.html'">Need an account? Register</label>
        </div>
    </form>

    <script>
        /// Show/Hide password ///
        const password   = document.getElementById('password');
        const setVisible = document.getElementById('setVisible');
        
        password.addEventListener('input', () => {
            if (password.value.length > 0) {
                setVisible.classList.add('visible');
            } else {
                setVisible.classList.remove('visible');
            }
        });

        setVisible.addEventListener('click', () => {
            if (password.type === 'password') {
                password.type = 'text';
                setVisible.textContent = 'Hide';
            } else {
                password.type = 'password';
                setVisible.textContent = 'Show';
            }
        });

        /// Login ///
        document.getElementById('loginForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://localhost:8001/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                console.log("üîç Raw response:", data);

                if (response.ok) {
                    // ‚úÖ Save login session in localStorage
                    localStorage.setItem("username", data.username);
                    localStorage.setItem("user_id", data.user_id);
                    
                    alert(`‚úÖ Login successful! Welcome, ${data.username}`);
                    window.location.href = 'fileService.html';
                } else {
                    // üëá Handle both object and array error formats
                    let errorMessage = "‚ùå Login failed.";

                    if (Array.isArray(data)) {
                        // Validation error list from FastAPI
                        errorMessage = data.map(err => err.msg).join(", ");
                    } else if (data.detail) {
                        // Normal HTTPException error
                        errorMessage = data.detail;
                    }

                    alert(`‚ùå ${errorMessage}`);
                }

            } catch (error) {
                console.error("‚ùå Network Error:", error);
                alert("‚ö†Ô∏è Unable to connect to the server.");
            }
        });
    </script>
</body>
</html>